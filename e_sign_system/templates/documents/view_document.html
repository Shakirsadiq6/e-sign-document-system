{% extends 'documents/base.html' %}

{% block title %}View Document - Document Signing System{% endblock %}

{% block extra_css %}
<style>
    .document-container {
        border: 1px solid #ddd;
        padding: 20px;
        min-height: 500px;
        background-color: #f9f9f9;
        position: relative;
    }
    .signature-mark {
        position: absolute;
        border: 2px dashed #007bff;
        padding: 10px;
        background-color: rgba(0, 123, 255, 0.1);
    }
</style>
{% endblock %}

{% block content %}
{% if is_temp_access %}
<div class="alert alert-info">
    <h4>Document Signing Request</h4>
    <p>You've been asked to review and sign this document.</p>
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h3>{{ document.filename }}</h3>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col">
                <strong>Status:</strong> 
                <span class="badge {% if document.status == 'pending' %}bg-warning{% elif document.status == 'signed' %}bg-success{% else %}bg-primary{% endif %}">
                    {{ document.status|title }}
                </span>
            </div>
            <div class="col">
                <strong>Upload Date:</strong> {{ document.upload_date }}
            </div>
            {% if document.signed_date %}
            <div class="col">
                <strong>Signed Date:</strong> {{ document.signed_date }}
            </div>
            {% endif %}
        </div>

        <div class="document-container">
            {% if document.signed_file %}
                <embed src="{{ document.signed_file.url }}" type="application/pdf" width="100%" height="500px">
            {% elif preview_image %}
                <img src="data:image/png;base64,{{ preview_image }}" alt="Document Preview" class="img-fluid">
            {% else %}
                <embed src="{{ document.file.url }}" type="application/pdf" width="100%" height="500px">
            {% endif %}
        
            <!-- Display signatures if any -->
            {% if document.signatures.all %}
                {% for sig in document.signatures.all %}
                    <div class="signature-mark" style="left: {{ sig.position_x }}px; top: {{ sig.position_y }}px;">
                        {% if sig.type == 'draw' or sig.type == 'upload' %}
                            <img src="data:image/png;base64,{{ sig.data }}" alt="Signature" style="max-width: 150px;">
                        {% elif sig.type == 'type' %}
                            <p class="mb-0">{{ sig.data }}</p>
                        {% endif %}
                        <small class="text-muted d-block">Signed by: {{ sig.signer_email }}</small>
                        <small class="text-muted d-block">Date: {{ sig.timestamp }}</small>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="mt-3">
            {% if document.status == 'pending' %}
                <a href="{% url 'documents:sign' document.id %}" class="btn btn-primary">Sign Document</a>
            {% elif document.status == 'signed' and not is_temp_access %}
                <a href="{% url 'documents:submit' document.id %}" class="btn btn-success">Submit Document</a>
            {% endif %}
            {% if document.signed_file %}
                <a href="{{ document.signed_file.url }}" class="btn btn-primary" download="{{ document.get_signed_filename }}">
                    Download Signed PDF
                </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}